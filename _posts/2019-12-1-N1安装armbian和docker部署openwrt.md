---
layout:     post
title:      N1安装armbian-docker部署openwrt
subtitle:   n1刷机操作
date:       2019-12-1
author:     deilt
header-img: img/post-n1-cover2.jpg
catalog: true
tags:
    - n1
---





# 前言

N1 作为这么强的一个盒子，光用来做旁路由实在太浪费了，今天教大家使用 N1 安装 armbian 系统（linux），安装 docker，部署 openwrt 等系列服务，废话不多说，关于 N1 降级和烧录固件的教程之前说过了：[这里](https://deilt.github.io/2019/11/29/n1%E5%88%B7%E6%97%81%E8%B7%AF%E7%94%B1/)

# 准备 armbian 固件包→下载地址：[这里](https://drive.google.com/open?id=166itYBaOtj7TaoFysyH1SShub2dhegJ5) 非凡哥的更多详细教程 烧录软件 [etcher](https://www.balena.io/etcher/) U 盘 2.0 一个

# 安装 armbian（推荐 armbian5.6 版本，稳定不折腾推荐）

## 一：开始

烧录固件到 U 盘，看主路由后台，找到 aml 这个 ip，登陆 armbian 的 ssh 用户名 root 密码 1234，首次进入会让你输入密码 然后创建新的密码，输入就行了，密码输入的时候是看不见的。完成后会让你创建新用户， ctrl+c 取消创建即可，这时，ambian 会重启。


![](/img/post-n1-a1.jpg)


![](/img/post-n1-a2.jpg)


## 二. 重启之后，敲入命令：
nand-sata-install 将 armbian 刷入 emmc，等刷入完成输入 poweroff 断电拔掉 U 盘，重新接通电源，等两分钟左右，看路由器后台 armbian 的 ip aml：ip 这就是刷入 emmc 后的 ip 了

三。这里需要说明一下，这里可以备份你所有刷入的固件，比如你刷入 armbian 到 emmc 后，折腾得差不多了，可以在这里输入 ddbr，选择 b 然后 y，等他下载完成，用 xftp 等工具进入 /ddbr 目录，将 - emmc.img.gz 下载到计算机，就完成了备份了，armbian 折腾出问题，又不想重新刷的时候，同样的插入这个 U 盘，输入 ddbr 然后 b，进度条开始选择 crtl+c 取消，进入 /ddbr 会看到一个文件，那个就是出问题的固件了，删掉。将备份包改成同样的名字，上传到这里，完成后回到 ssh，再次输入 ddbr 选择 r 然后 y，等待刷入，完成后，输入 poweroff，拔电，拔掉 U 盘，崭新的 armbian 就回来了。


# 开启 BBR 加速：

cat >> /etc/sysctl.conf << EOF

net.core.default_qdisc=fq

net.ipv4.tcp_congestion_control=bbr

EOF

sysctl -p

# 安装所有常用包：

5.6/5.77：apt install ipset tcpdump pppoe pppoeconf net-tools git dnsmasq isc-dhcp-server cifs-utils tcptraceroute iftop telnet -y

# 更换国内源：我是照着非凡哥的教程的

1，先执行：nano /etc/apt/sources.list，

2，在自带的源 deb 前面加上 #注释掉，变成紫色。

3，把下面的对应版本的源全部复制粘贴回车，最后按 ctrl+x，按 Y 确定。最后按回车

4，最后执行 apt-get update

# 更新源 5.6+5.77 (debian 9):
deb http://mirrors.tuna.tsinghua.edu.cn/debian stretch main contrib non-free

deb http://mirrors.tuna.tsinghua.edu.cn/debian stretch-updates main contrib non-free

deb http://mirrors.tuna.tsinghua.edu.cn/debian-security stretch/updates main contrib non-free

deb http://mirrors.tuna.tsinghua.edu.cn/debian stretch-backports main


# 安装 docker：

docker 官网：https://hub.docker.com

1，执行
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh --mirror Aliyun
耐心等待一段时间安装完成

2. 安装 docker 图形化管理 portainer：登陆地址为 armbianip:9000
执行：
docker volume create portainer_data

docker run -d -p 9000:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer:linux-arm64

# 修改 armbian 为静态 ip，以防跳 mac 地址，也就是 ip 重启后变动

把 armbian 修改为静态 ip 地址和改 DNS：改静态是为了在安装 docker 的 op 下，能登录 armbian 的 ssh：

用 xftp 或者 moba 等 ssh 工具进入 /etc/network，找到 interfaces 文件，右键记事本编辑：

adress：换成你的 armbian ip，也可以自定义比如我的 192.168.2.2

gateway：换成主路由的 ip，等之后 docker 部署好 OP 后，这里的 ip 就可以改成 OP 的 ip 了（让 armbian 翻墙，以后的教程有用）

allow-hotplug eth0

no-auto-down eth0

iface eth0 inet static

address 192.168.2.2 #我的 armbian ip

netmask 255.255.255.0

gateway 192.168.2.1# 我的主路由 ip

dns-nameservers 192.168.2.1# 主路由 dns 同上 部署好 OP 后记得修改为 OP 的 ip，dns 也改成 op 的 ip

# 改 DNS：

再进 etc 目录，按下面的修改 resolv.conf 文件，用记事本打开，把解析的 dns ip 改为主路由（部署好 OP 后改为 OP 的）的，如下面的 192.168.2.1 就是我的主路由 ip

Generated by NetworkManager

search lan

nameserver 192.168.2.1

## 改完后 ssh 执行 reboot 重启一下，重启后 armbian 的 ssh 登陆 ip 为你刚才改过的，不要弄错了

## 查看网关：

执行 route -n 查看 DNS：执行 nslookup www.baidu.com

## 部署 openwrt 简称 op

## 登陆 armbian ssh

执行：这是第一次的部署命令，部署过第一次后，只需要执行第一条和最后一条命令

docker pull kanshudj/n1-openwrtgateway:latest

ip link set eth0 promisc on

modprobe pppoe

docker network create -d macvlan --subnet=192.168.2.0/24 --gateway=192.168.2.1 -o parent=eth0 macnet

docker run --restart always -d --network macnet --privileged kanshudj/n1-openwrtgateway:latest /sbin/init

单独执行，如果没变化，稍微等待一会儿部署好

默认安装最新的版本

# 登陆 docker 的图形化界面，输入 armbian 的 ip:9000

创建用户名和密码，登陆

选择本地 local，也就是第一个

点鸡左边的 container 菜单，找到 openwrt 点击如下

输入 vi /etc/config/network，按 i 改网关信息，op 的 ip 要改成跟主路由同网关，比如 192.168.2.1 和 192.168.2.2，改好后依次按返回键，:wq 保存退出。再点 disconnect，在 containers 那勾选 op **一定要点 restart 重启 op**

![](/img/post-n1-a3.jpg)

![](/img/post-n1-a4.jpg)

登陆 OP 设置，之前的帖子有说明：[这里](https://deilt.github.io/2019/11/29/n1%E5%88%B7%E6%97%81%E8%B7%AF%E7%94%B1/)，然后回到设置 ip 和 dns 那里，将 ip 和 dns 改成现在 OP 的 ip

docker 理论可以 部署 N 个 OP，每个的 IP 都改成不一样的就好，建议只留一个，不要的就 remove 掉，然后 Images，删掉不用的包

Enjoy it 开启你的翻墙 SSR 之旅 ！
